<p>C# 7 finally introduced a long-awaited feature called "pattern matching". If you're familiar with functional languages like F# you may be slightly disappointed with this feature in its current state, but even today it can simplify your code in a variety of different scenarios.
<p>Every new feature is fraught with danger for a developer working on a performance critical application. New levels of abstractions are good but in order to use them effectively, you should know what is happening under the hood. Today we're going to explore pattern matching and look under the covers to understand how it is implemented.
<p>The C# language introduced the notion of a pattern that can be used in <code>is</code>-expression and inside a <code>case</code> block of a <code>switch</code> statement.
<p>There are 3 types of patterns:
<ul>
<li>The const pattern 
<li>The type pattern 
<li>The <code>var</code> pattern</li></ul>
<h4>Pattern matching in <code>is</code>-expressions</h4>
<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> IsExpressions(</font><span style="color: "><font color="#569cd6">object</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Alternative way checking for null</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">null</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"o is null"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Const pattern can refer to a constant value</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">const</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">double</font></span><font color="#dcdcdc"> value </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">double</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">NaN;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc"> value) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"o is value"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Const pattern can use a string literal</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#d69d85">"o"</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"o is </font></span><span style="color: "><font color="#e07a00">\"</font></span><span style="color: "><font color="#d69d85">o</font></span><span style="color: "><font color="#e07a00">\"</font></span><span style="color: "><font color="#d69d85">"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Type pattern</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">WriteLine(n);<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Type pattern and compound expressions</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Trim() </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">Empty)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"o is not blank"</font></span><font color="#dcdcdc">);<br>}</font></font></font></pre>
<p><code>is</code>-expression can check if the value is equal to a constant and a type check can optionally specify the <strong>pattern variable</strong>.
<p>I've found few interesting aspects related to pattern matching in <code>is</code>-expressions:
<ul>
<li>Variable introduced in an <code>if</code> statement is lifted to the outer scope. 
<li>Variable introduced in an <code>if</code> statement is definitely assigned only when the pattern is matched. 
<li>Current implementation of the const pattern matching in <code>is</code>-expressions is not very efficient.</li></ul>
<p>Let's check the first two cases first:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> ScopeAndDefiniteAssigning(</font><span style="color: "><font color="#569cd6">object</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"o is not empty string"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Can't use 's' any more. 's' is already declared in the current scope.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">||</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s2 </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryParse(s2, </font><span style="color: "><font color="#569cd6">out</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc"> n)))<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(n);<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>The first <code>if</code> statement introduces a variable <code>s</code> and the variable is visible inside the whole method. This is reasonable but will complicate the logic if the other if-statements in the same block will try to reuse the same name once again. In this case, you <strong>have</strong> to use another name to avoid the collision.
<p>The variable introduced in the <code>is</code>-expression is definitely assigned only when the predicate is <code>true</code>. It means that the <code>n</code> variable in the second if-statement is not assigned in the right operand but because the variable is already declared we can use it as the <code>out</code> variable in the <code>int.TryParse</code> method.
<p>The third aspect mentioned above is the most concerning one. Consider the following code:
<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> BoxTwice(</font><span style="color: "><font color="#569cd6">int</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc"> n)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (n </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">42</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"n is 42"</font></span><font color="#dcdcdc">);<br>}</font></font></font><br></pre>
<p>In most cases the <code>is</code>-expression is translated to the <code>object.Equals(constValue, variable)</code> (even though the spec says that <code>operator==</code> should be used for primitive types):<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> BoxTwice(</font><span style="color: "><font color="#569cd6">int</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> n)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#569cd6">object</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Equals(</font><span style="color: "><font color="#b5cea8">42</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">, n))<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"n is 42"</font></span><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>This code causes 2 boxing allocations that can reasonable affect performance if used in the application's critical path. It used to be the case that <code>o is null</code>was causing the boxing allocation if <code>o</code> is a nullable value type (see <a href="https://github.com/dotnet/roslyn/issues/13247">Suboptimal code for e is null</a>) so I really hope that this behavior will be fixed (here is <a href="https://github.com/dotnet/roslyn/issues/20642">an issue on github</a>).
<p>If the <code>n</code> variable is of type <code>object</code> the <code>o is 42</code> will cause one boxing allocation (for the literal <code>42</code>), even though the similar switch-based code would not cause any allocations.
<h4>The <code>var</code> patterns in <code>is</code>-expressions</h4>
<p>The <code>var</code> pattern is a special case of the type pattern with one major distinction: the pattern will match any value, even if the value is <code>null</code>.<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> IsVar(</font><span style="color: "><font color="#569cd6">object</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc"> o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> x) </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">$"x: </font></span><font color="#dcdcdc">{x}</font><span style="color: "><font color="#d69d85">"</font></span><font color="#dcdcdc">);<br>}</font></font></font></pre>
<p><code>o is object</code> is <code>true</code> when <code>o</code> is not <code>null</code>, but <code>o is var x</code> is always <code>true</code>. The compiler knows about that and in the Release mode (*), it removes the if-clause altogether and just leaves the <code>Console</code> method call. Unfortunately, the compiler does not warn you that the code is unreachable in the following case: <code>if (!(o is var x)) Console.WriteLine("Unreachable")</code>. Hopefully, this will be fixed as well.
<p>(*) It is not clear why the behavior is different in the Release mode only. But I think all the issues falls into the same bucker: the initial implementation of the feature is suboptimal. But based on <a href="https://github.com/dotnet/roslyn/issues/22654#issuecomment-336329881">this comment</a> by Neal Gafter, this is going to change: "The pattern-matching lowering code is being rewritten from scratch (to support recursive patterns, too). I expect most of the improvements you seek here will come for "free" in the new code. But it will be some time before that rewrite is ready for prime time.".
<p>The lack of <code>null</code> check makes this case very special and potentially dangerous. But if you know what exactly is going on you may find this pattern useful. It can be used for introducing a temporary variable inside the expression:
<div style="font-family: ; white-space: nowrap; color: ; line-height: 19px; background-color: #1e1e1e">
<div><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#d4d4d4"><span style="color: "> </span><span style="color: ">void </span></font><span style="color: "><font color="#dcdcaa">VarPattern</font></span><span style="color: "><font color="#d4d4d4">(</font></span><span style="color: "><font color="#4ec9b0">IEnumerable</font></span><span style="color: "><font color="#d4d4d4">&lt;</font></span><span style="color: "><font color="#569cd6">string</font></span></font><span style="color: "><font style="font-size: 10pt" color="#d4d4d4">&gt; s)</font></span></font></div>
<div><span style="color: "><font face="Consolas"><font style="font-size: 10pt" color="#d4d4d4">{</font></font></span></div>
<div><span style="color: "></span><font face="Consolas"><span style="color: "><font color="#c586c0"><font style="font-size: 10pt">if</font></font></span><font style="font-size: 10pt"><span style="color: "><font color="#d4d4d4"> (</font></span><span style="color: "><font color="#9cdcfe">s</font></span><span style="color: "><font color="#d4d4d4">.</font></span><span style="color: "><font color="#dcdcaa">FirstOrDefault</font></span><span style="color: "><font color="#d4d4d4">(o =&gt; </font></span><span style="color: "><font color="#9cdcfe">o</font></span><span style="color: "><font color="#d4d4d4"> != </font></span><span style="color: "><font color="#569cd6">null</font></span><span style="color: "><font color="#d4d4d4">) </font></span><span style="color: "><font color="#569cd6">is</font></span><font color="#d4d4d4"><span style="color: "> </span><span style="color: ">var </span></font><span style="color: "><font color="#9cdcfe">v</font></span></font><span style="color: "><font style="font-size: 10pt" color="#d4d4d4"> </font></span></font></div>
<div><font face="Consolas"><span style="color: "><font color="#d4d4d4"><font style="font-size: 10pt">&amp;&amp; </font></font></span><font style="font-size: 10pt"><span style="color: "><font color="#9cdcfe">int</font></span><span style="color: "><font color="#d4d4d4">.</font></span><span style="color: "><font color="#dcdcaa">TryParse</font></span><span style="color: "><font color="#d4d4d4">(</font></span><span style="color: "><font color="#9cdcfe">v</font></span><span style="color: "><font color="#d4d4d4">, </font></span><span style="color: "><font color="#569cd6">out</font></span><span style="color: "><font color="#d4d4d4"> </font></span><span style="color: "><font color="#569cd6">var</font></span></font><span style="color: "><font style="font-size: 10pt" color="#d4d4d4"> n))</font></span></font></div>
<div><span style="color: "><font face="Consolas"><font style="font-size: 10pt" color="#d4d4d4">{</font></font></span></div>
<div><span style="color: "></span><font face="Consolas"><span style="color: "><font color="#9cdcfe"><font style="font-size: 10pt">Console</font></font></span><font style="font-size: 10pt"><span style="color: "><font color="#d4d4d4">.</font></span><span style="color: "><font color="#dcdcaa">WriteLine</font></span><span style="color: "><font color="#d4d4d4">(</font></span><span style="color: "><font color="#9cdcfe">n</font></span></font><span style="color: "><font style="font-size: 10pt" color="#d4d4d4">);</font></span></font></div>
<div><span style="color: "><font face="Consolas"><font style="font-size: 10pt" color="#d4d4d4">}</font></font></span></div>
<div><span style="color: "><font face="Consolas"><font style="font-size: 10pt" color="#d4d4d4">}</font></font></span></div></div>
<h4><code>Is</code>-expression meets "Elvis" operator</h4>
<p>There is another use case that I've found very useful. The type pattern matches the value only when the value is not <code>null</code>. We can use this "filtering" logic with the null-propagating operator to make a code easier to read:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> WithNullPropagation(</font><span style="color: "><font color="#b8d7a3">IEnumerable</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">string</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc">&gt; s)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (s</font><span style="color: "><font color="#b4b4b4">?.</font></span><font color="#dcdcdc">FirstOrDefault(str </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><font color="#dcdcdc"> str</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#b4b4b4">&gt;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">10</font></span><font color="#dcdcdc">)</font><span style="color: "><font color="#b4b4b4">?.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc"> length)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">WriteLine(length);<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Similar to</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (s</font><span style="color: "><font color="#b4b4b4">?.</font></span><font color="#dcdcdc">FirstOrDefault(str </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><font color="#dcdcdc"> str</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#b4b4b4">&gt;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">10</font></span><font color="#dcdcdc">)</font><span style="color: "><font color="#b4b4b4">?.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> length2 </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> length2 </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">null</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">WriteLine(length2);<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// And similar to</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> length3 </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">?.</font></span><font color="#dcdcdc">FirstOrDefault(str </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><font color="#dcdcdc"> str</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Length </font><span style="color: "><font color="#b4b4b4">&gt;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">10</font></span><font color="#dcdcdc">)</font><span style="color: "><font color="#b4b4b4">?.</font></span></font><font face="Consolas"><font color="#dcdcdc">Length;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (length3 </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">null</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(length3);<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>Note, that the same pattern can be used for both - value types and reference types.
<h4>Pattern matching in the <code>case</code> blocks</h4>
<p>C# 7 extends the switch statement to use patterns in the case clauses:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">static</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> Count&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span><font color="#dcdcdc">&gt;(</font><span style="color: "><font color="#569cd6">this</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">IEnumerable</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc">&gt; e)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">switch</font></span></font><font face="Consolas"><font color="#dcdcdc"> (e)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">ICollection</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span><font color="#dcdcdc">&gt; c: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> c</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Count;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">IReadOnlyCollection</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span><font color="#dcdcdc">&gt; c: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> c</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Count;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Matches concurrent collections</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">IProducerConsumerCollection</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span><font color="#dcdcdc">&gt; pc: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> pc</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Count;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Matches if e is not null</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">IEnumerable</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#b8d7a3">T</font></span><font color="#dcdcdc">&gt; </font><span style="color: "><font color="#569cd6">_</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> e</font><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">Count();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Default case is handled when e is null</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">default</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>The example shows the first set of changes to the switch statement.
<ol>
<li>A variable of any type may be used in a switch statement. 
<li>A case clause can specify a pattern. 
<li>The order of the case clauses matters. The compiler emits an error if the previous clause matches a base type and the next clause matches a derived type. 
<li>Non default clauses have an implicit null check (**). In the example before the very last case clause is valid because it matches only when the argument is not <code>null</code>.</li></ol>
<p>(**) The very last case clause shows another feature added to C# 7 called "discard" pattern. The name <code>_</code> is special and tells the compiler that the variable is not needed. The type pattern in a case clause requires an alias and if you don't need it you can ignore it using <code>_</code>.
<p>The next snippet shows another feature of the switch-based pattern matching - an ability to use predicates:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">static</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> FizzBuzz(</font><span style="color: "><font color="#569cd6">object</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">switch</font></span></font><font face="Consolas"><font color="#dcdcdc"> (o)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Contains(</font><span style="color: "><font color="#d69d85">"Fizz"</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#b4b4b4">||</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Contains(</font><span style="color: "><font color="#d69d85">"Buzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">):<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">WriteLine(s);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">break</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">5</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"FizzBuzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">break</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">5</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"Fizz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">break</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"Buzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">break</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc"> n:<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">WriteLine(n);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">break</font></span><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>This is a weird version of the <a href="http://wiki.c2.com/?FizzBuzzTest">FizzBuzz</a> problem that processes an <code>object</code>instead of just a number.
<p>A switch can have more than one case clause with the same type. If this happens the compiler groups together all type checks to avoid redundant computations:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">public</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">static</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc"> FizzBuzz(</font><span style="color: "><font color="#569cd6">object</font></span></font></font><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// All cases can match only if the value is not null</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">null</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Contains(</font><span style="color: "><font color="#d69d85">"Fizz"</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#b4b4b4">||</font></span><font color="#dcdcdc"> s</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Contains(</font><span style="color: "><font color="#d69d85">"Buzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">)))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">WriteLine(s);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">bool</font></span><font color="#dcdcdc"> isInt </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> num </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> isInt </font><span style="color: "><font color="#b4b4b4">?</font></span><font color="#dcdcdc"> ((</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc">)o) </font><span style="color: "><font color="#b4b4b4">:</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span></font><font face="Consolas"><font color="#dcdcdc"> (isInt)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The type check and unboxing happens only once per group</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (num </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">5</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> num </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"FizzBuzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (num </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">5</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"Fizz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (num </font><span style="color: "><font color="#b4b4b4">%</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"Buzz"</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(num);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>But there are two things to keep in mind:
<ol>
<li>The compiler will group together only consecutive type checks and if you'll intermix cases for different types the compiler will generate less optimal code:</li></ol><pre style="font-family: ; background: #1e1e1e; color: "><span style="color: "><font color="#569cd6" face="Consolas"><font style="font-size: 10pt">switch</font></font></span><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> (o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The generated code is less optimal:</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// If o is int, then more than one type check and unboxing operation</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// may happen.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#d69d85">""</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">default</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">;<br>}</font></font></font></pre>
<p>The compiler will translate it effectively to the following:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 10pt">if</font></font></span><font style="font-size: 10pt"><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">;</font><br><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> s </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#d69d85">""</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span><font color="#dcdcdc">;</font><br><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (o </font><span style="color: "><font color="#569cd6">is</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n2 </font><span style="color: "><font color="#b4b4b4">&amp;&amp;</font></span><font color="#dcdcdc"> n2 </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span><font color="#dcdcdc">) </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">3</font></span><font color="#dcdcdc">;</font><br><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">;</font></font></font></pre>
<ol start="2">
<li>The compiler tries it best to prevent common ordering issues.</li></ol><pre style="font-family: ; background: #1e1e1e; color: "><span style="color: "><font color="#569cd6" face="Consolas"><font style="font-size: 10pt">switch</font></font></span><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> (o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Error: The switch case has already been handled by a previous case.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span><font color="#dcdcdc">;<br>}</font></font></font></pre>
<p>But compiler doesn't know that one predicate is stronger than the other and effectively supersedes the next cases:<pre style="font-family: ; background: #1e1e1e; color: "><span style="color: "><font color="#569cd6" face="Consolas"><font style="font-size: 10pt">switch</font></font></span><font style="font-size: 10pt"><font face="Consolas"><font color="#dcdcdc"> (o)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">&gt;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span></font></font><font face="Consolas"><font style="font-size: 10pt"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Will never match, but the compiler won't warn you about it</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">case</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#569cd6">when</font></span><font color="#dcdcdc"> n </font><span style="color: "><font color="#b4b4b4">&gt;</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">1</font></span><font color="#dcdcdc">: </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">2</font></span><font color="#dcdcdc">;<br>}</font></font></font></pre>
<h4>Pattern matching 101</h4>
<ul>
<li>C# 7 introduced the following patterns: the const pattern, the type pattern, the var pattern and the discard pattern. 
<li>Patterns can be used in <code>is</code>-expressions and in case blocks. 
<li>The implementation of the const pattern in <code>is</code>-expression for value types is far from perfect from the performance point of view. 
<li>The <code>var</code>-pattern always match and you should be careful with them. 
<li>A switch statement can be used for a set of type checks with additional predicates in <code>when</code> clauses.</li></ul>