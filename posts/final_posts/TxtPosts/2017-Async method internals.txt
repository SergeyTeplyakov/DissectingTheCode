<p>The C# language is great for developer's productivity and I'm glad for the recent push towards making it more suitable for high-performance applications.
<p>Here is an example: C# 5 introduced 'async' methods. The feature is very useful from a user's point of view because it helps combining several task-based operations into one. But this abstraction comes at a cost. Tasks are reference types causing heap allocations everywhere they're created, even in cases where the 'async' method completes synchronously. With C# 7, async methods can return task-like types such as <code>ValueTask</code> to reduce the number of heap allocations or avoid them altogether in some scenarios.
<p>In order to understand how all of this is possible, we need to look under the hood and see how async methods are implemented.
<p>But first, a little bit of history.
<p>Classes <code>Task</code> and <code>Task&lt;T&gt;</code> were introduced in .NET 4.0 and, from my perspective, made a huge mental shift in area of asynchronous and parallel programming in .NET. Unlike older asynchronous patterns such as the <code>BeginXXX</code>/<code>EndXXX</code> pattern from .NET 1.0 (also known as <a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/asynchronous-programming-model-apm">"Asynchronous Programming Model"</a>) or <a href="https://docs.microsoft.com/en-us/dotnet/standard/asynchronous-programming-patterns/event-based-asynchronous-pattern-overview">Event-based Asynchronous Pattern</a> like <a href="https://docs.microsoft.com/en-us/dotnet/framework/winforms/controls/backgroundworker-component"><code>BackgroundWorker</code></a> class from .NET 2.0, tasks are composable.
<p>A task represents a unit of work with a promise to give you results back in the future. That promise could be backed by IO-operation or represent a computation-intensive operation. It doesn't matter. What does matter is that the result of the operation is self-sufficient and is a first-class citizen. You can pass a "future" around: you can store it in a variable, return it from a method, or pass it to another method. You can "join" two "futures" together to form another one, you can wait for results synchronously or you can "await" the result by adding "continuation" to the "future". You can decide what to do if the operation succeeded, failed or was canceled, just using a task instance alone.
<p>Task Parallel Library (TPL) had changed the way we think about concurrency and C# 5 language made a step forward by introducing <code>async</code>/<code>await</code>. Async/await helps to compose tasks and gives the user an ability to use well-known constructs like <code>try/catch</code>, <code>using</code> etc. But like any other abstraction <code>async/await</code> feature has its cost. And to understand what the cost is, you have to look under the hood.
<h4>Async method internals</h4>
<p>A regular method has just one entry point and one exit point (it could have more than one <code>return</code> statement but at the runtime there is just one exist point for a given call). But async methods (*) and iterators (methods with <code>yield return</code>) are different. In the case of an async method, a method caller can get the result (i.e. <code>Task</code> or <code>Task&lt;T&gt;</code>) almost immediately and then "await" the actual result of the method via the resulting task.
<p>(*) I'm using the term "async method" in one specific way: a method marked with contextual keyword <code>async</code>. It doesn't mean that the entire method is asynchronous. It doesn't mean that the method is asynchronous at all. It only means that the compiler performs some special transformation to the method.
<p>Let's consider the following async method:<pre><code><p>&nbsp;</p><pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 11pt">class</font></font></span><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">StockPrices</font></span><br></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc">{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Dictionary</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc">, </font><span style="color: "><font color="#569cd6">decimal</font></span></font><font face="Consolas"><font color="#dcdcdc">&gt; _stockPrices;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">async</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt; GetStockPriceForAsync(</font><span style="color: "><font color="#569cd6">string</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">await</font></span></font><font face="Consolas"><font color="#dcdcdc"> InitializeMapIfNeededAsync();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _stockPrices</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryGetValue(companyId, </font><span style="color: "><font color="#569cd6">out</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">var</font></span></font><font face="Consolas"><font color="#dcdcdc"> result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc"> result;<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">async</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span></font><font face="Consolas"><font color="#dcdcdc"> InitializeMapIfNeededAsync()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (_stockPrices </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">null</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">await</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Delay(</font><span style="color: "><font color="#b5cea8">42</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Getting the stock prices from the external source.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _stockPrices </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Dictionary</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">string</font></span><font color="#dcdcdc">, </font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt; { { </font><span style="color: "><font color="#d69d85">"MSFT"</font></span><font color="#dcdcdc">, </font><span style="color: "><font color="#b5cea8">42</font></span><font color="#dcdcdc"> } };<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre></code></pre>
<p>Method <code>GetStockPriceForAsync</code> ensures that the cache is initialized and then gets the value from the cache. This is a common pattern when the method is IO bound and relatively slow if the cache is cold and is way more efficient for all subsequent invocations.
<p>To better understand what the compiler does or can do, let's try to write a transformation by hand.
<h4>Deconstructing an async method by hand</h4>
<p>The TPL provides two main building blocks that helps us constructing and joining tasks: task continuation using <code>Task.ContinueWith</code> and <code>TaskCompletionSource&lt;T&gt;</code> class for constructing tasks by hand.<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 11pt">class</font></font></span><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">GetStockPriceForAsync_StateMachine</font></span><br></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc">{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">enum</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span></font><font face="Consolas"><font color="#dcdcdc"> { Start, Step1, }<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">readonly</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">StockPrices</font></span></font><font face="Consolas"><font color="#dcdcdc"> @this;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">readonly</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span></font><font face="Consolas"><font color="#dcdcdc"> _companyId;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">readonly</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">TaskCompletionSource</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span></font><font face="Consolas"><font color="#dcdcdc">&gt; _tcs;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span></font><font face="Consolas"><font color="#dcdcdc"> _initializeMapIfNeededTask;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><font color="#dcdcdc"> _state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Start;<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc"> GetStockPriceForAsync_StateMachine(</font><span style="color: "><font color="#4ec9b0">StockPrices</font></span><font color="#dcdcdc"> @this, </font><span style="color: "><font color="#569cd6">string</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">this</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">@this </font><span style="color: "><font color="#b4b4b4">=</font></span></font><font face="Consolas"><font color="#dcdcdc"> @this;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _companyId </font><span style="color: "><font color="#b4b4b4">=</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId;<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span></font><font face="Consolas"><font color="#dcdcdc"> Start()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">try</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (_state </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Start)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The Code from the start of the method to the first 'await'.</font></span><br></font><font face="Consolas"><font color="#dcdcdc"> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#569cd6">string</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">IsNullOrEmpty(_companyId))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">throw</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">ArgumentNullException</font></span></font><font face="Consolas"><font color="#dcdcdc">();<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _initializeMapIfNeededTask </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> @this</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">InitializeMapIfNeeded();<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Schedule continuation</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Step1;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _initializeMapIfNeededTask</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">ContinueWith(_ </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span></font><font face="Consolas"><font color="#dcdcdc"> Start());<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">else</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (_state </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Step1)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Need to check the error and the cancel case first</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (_initializeMapIfNeededTask</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Status </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">TaskStatus</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Canceled)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tcs</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">SetCanceled();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">else</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (_initializeMapIfNeededTask</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Status </font><span style="color: "><font color="#b4b4b4">==</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">TaskStatus</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Faulted)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tcs</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">SetException(_initializeMapIfNeededTask</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Exception</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">InnerException);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">else</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The code between first await and the rest of the method</font></span><br></font><font face="Consolas"><font color="#dcdcdc"> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; @this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">_store</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryGetValue(_companyId, </font><span style="color: "><font color="#569cd6">out</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">var</font></span></font><font face="Consolas"><font color="#dcdcdc"> result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tcs</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">SetResult(result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">catch</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#4ec9b0">Exception</font></span></font><font face="Consolas"><font color="#dcdcdc"> e)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; _tcs</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">SetException(e);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt; Task </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><font color="#dcdcdc"> _tcs</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Task;<br>}<br> </font><br><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt; GetStockPriceForAsync(</font><span style="color: "><font color="#569cd6">string</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> stateMachine </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">GetStockPriceForAsync_StateMachine</font></span><font color="#dcdcdc">(</font><span style="color: "><font color="#569cd6">this</font></span></font><font face="Consolas"><font color="#dcdcdc">, companyId);<br>&nbsp;&nbsp;&nbsp; stateMachine</font><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">Start();<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> stateMachine</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Task;<br>}</font></font></font></pre><pre></pre>
<p>The code is verbose but relatively straightforward. All the logic from <code>GetStockPriceForAsync</code> is moved to <code>GetStockPriceForAsync_StateMachine.Start</code> method that uses <a href="https://en.wikipedia.org/wiki/Continuation-passing_style">"continuation passing style"</a>. The original method is split into pieces using <code>await</code> statements as a separator. The first block is the code from the start of the method to the first <code>await</code>. The second block - from the first <code>await</code> to the second <code>await</code>. The third block - from the second <code>await</code> to the third one or until the end of the method, and so forth:<code><pre><pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#57a64a"><font style="font-size: 11pt">// State 1 of the generated state machine:</font></font></span><font style="font-size: 11pt"><br><font color="#dcdcdc"> </font><br><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#569cd6">string</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">IsNullOrEmpty(_companyId)) </font><span style="color: "><font color="#569cd6">throw</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">ArgumentNullException</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">();<br>_initializeMapIfNeededTask </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> @this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">InitializeMapIfNeeded();</font></font></font></pre></code></pre>
<p>Every "awaitable" task now become a field of the state machine, and the <code>Start</code> method subscribe itself as a continuation of it:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><font color="#dcdcdc"><font style="font-size: 11pt">_state </font></font><font style="font-size: 11pt"><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">State</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">Step1;<br>_initializeMapIfNeededTask</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">ContinueWith(_ </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><font color="#dcdcdc"> Start());</font></font></font></pre>
<p>Then, when the task finishes, the <code>Start</code> method is called back, the <code>_state</code>field is checked to understand what stage we're in. The logic then checks whether the task was finished successfully, was canceled, or successful. In the latter case, the state machine moves forward and runs the next block of code. When everything is done, the state machine sets the result of the <code>TaskCompletionSource&lt;T&gt;</code> instance and the resulting task returned from <code>GetStockPricesForAsync</code> changes its state to completion.<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#57a64a"><font style="font-size: 11pt">// The code between first await and the rest of the method</font></font></span><font style="font-size: 11pt"><br></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc"> <br>@this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">_store</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryGetValue(_companyId, </font><span style="color: "><font color="#569cd6">out</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">var</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc"> result);<br>_tcs</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">SetResult(result); </font></font><span style="color: "><font style="font-size: 11pt" color="#57a64a">// The caller gets the result back</font></span></font></pre>
<p>This "implementation" has few serious drawbacks:
<ul>
<li>Lots of heap allocations: 1 allocation for the state machine, 1 allocation for <code>TaskCompletionSource&lt;T&gt;</code>, 1 allocation for task inside a <code>TaskCompletionSource&lt;T&gt;</code>, 1 allocation for continuation delegate. 
<li>Lack of "hot path optimizations": if the "awaitable" task was already finished there is no sense for creating a continuation. 
<li>Lack of extensibility: the implementation is tightly coupled with Task-based classes that makes impossible other scenarios, like awaiting other types or returning types other than <code>Task</code> or <code>Task&lt;T&gt;</code>.</li></ul>
<p>Now let's take a look at the actual async machinery to see how these concerns are addressed.
<h4>Async machinery</h4>
<p>The overall approach that compiler takes for async method transformation is very similar to one mentioned above. To get the desired behavior the compiler relies on the following types:
<ol>
<li>Generated state machine that acts like a stack frame for an asynchronous method and contains all the logic from the original async method (**). 
<li><a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,5916df9e324fc0a1"><code>AsyncTaskMethodBuilder&lt;T&gt;</code></a> that keeps the completed task (very similar to <code>TaskCompletionSource&lt;T&gt;</code> type) and manages the state transition of the state machine. 
<li><a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/TaskAwaiter.cs,2c48fb3bdfc69022"><code>TaskAwaiter&lt;T&gt;</code></a> that wraps a task and schedules a continuation of it if needed. 
<li><a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,c7b2691b131812c7"><code>MoveNextRunner</code></a> that knows how to call <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/IAsyncStateMachine.cs,22e8d7df64651ee3"><code>IStateMachine.MoveNext</code></a>method in a correct execution context.</li></ol>
<p><strong>The generated state machine is a class in debug mode and a struct in release mode</strong>. All the other types (except <code>MoveNextRunner</code> class) are defined in the BCL as structs.
<p>(**) The compiler generate type name like <code>&lt;YourMethodNameAsync&gt;d__1</code>. To avoid name collisions the generated name contains invalid character and can't be defined or referenced by the user. But for simplicity sake in all the following examples, I will use valid identifiers by replacing <code>&lt;</code> and <code>&gt;</code> characters with <code>_</code> or simplifying them a little bit.
<h5>The original method</h5>
<p>Original "asynchronous" method creates a state machine instance, initializes it with the captured state (including <code>this</code> pointer if the method is not static) and then starts the execution by calling <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,454"><code>AsyncTaskMethodBuilder&lt;T&gt;.Start</code></a> with the state machine instance passed by reference.<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><font color="#dcdcdc"><font style="font-size: 11pt">[</font></font><font style="font-size: 11pt"><span style="color: "><font color="#4ec9b0">AsyncStateMachine</font></span><font color="#dcdcdc">(</font><span style="color: "><font color="#569cd6">typeof</font></span><font color="#dcdcdc">(</font><span style="color: "><font color="#4ec9b0">_GetStockPriceForAsync_d__1</font></span><font color="#dcdcdc">))]</font><br><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt; GetStockPriceFor(</font><span style="color: "><font color="#569cd6">string</font></span></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc"> companyId)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">_GetStockPriceForAsync_d__1</font></span></font><font face="Consolas"><font color="#dcdcdc"> _GetStockPriceFor_d__;<br>&nbsp;&nbsp;&nbsp; _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">__this </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">this</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">companyId </font><span style="color: "><font color="#b4b4b4">=</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId;<br>&nbsp;&nbsp;&nbsp; _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">__builder </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">AsyncTaskMethodBuilder</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span><font color="#dcdcdc">&gt;</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Create();<br>&nbsp;&nbsp;&nbsp; _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">__state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">1</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> __t__builder </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">__builder;<br>&nbsp;&nbsp;&nbsp; __t__builder</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Start&lt;</font><span style="color: "><font color="#4ec9b0">_GetStockPriceForAsync_d__1</font></span><font color="#dcdcdc">&gt;(</font><span style="color: "><font color="#569cd6">ref</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc"> _GetStockPriceFor_d__);<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc"> _GetStockPriceFor_d__</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">__builder</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Task;<br>}</font></font></font></pre>
<p><strong>Passing by reference</strong> is an important optimization, because a state machine tends to be fairly large struct (&gt;100 bytes) and passing it by reference avoids a redundant copy.
<h5>The state machine</h5>
<p>The generated state machine looks complicated, but in essence, it is very similar to one we created by hand:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 11pt">struct</font></font></span><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">_GetStockPriceForAsync_d__1</font></span><font color="#dcdcdc"> : </font><span style="color: "><font color="#b8d7a3">IAsyncStateMachine</font></span><br></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc">{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">StockPrices</font></span></font><font face="Consolas"><font color="#dcdcdc"> __this;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">string</font></span></font><font face="Consolas"><font color="#dcdcdc"> companyId;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">AsyncTaskMethodBuilder</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">decimal</font></span></font><font face="Consolas"><font color="#dcdcdc">&gt; __builder;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc"> __state;<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">private</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">TaskAwaiter</font></span></font><font face="Consolas"><font color="#dcdcdc"> __task1Awaiter;<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">public</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">void</font></span></font><font face="Consolas"><font color="#dcdcdc"> MoveNext()<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">decimal</font></span></font><font face="Consolas"><font color="#dcdcdc"> result;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">try</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">TaskAwaiter</font></span></font><font face="Consolas"><font color="#dcdcdc"> awaiter;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (__state </font><span style="color: "><font color="#b4b4b4">!=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// State 1 of the generated state machine:</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#569cd6">string</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">IsNullOrEmpty(companyId))<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">throw</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">ArgumentNullException</font></span></font><font face="Consolas"><font color="#dcdcdc">();<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; awaiter </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> __this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">InitializeLocalStoreIfNeededAsync()</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">GetAwaiter();<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Hot path optimization: if the task is completed,</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// the state machine automatically moves to the next step</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#b4b4b4">!</font></span><font color="#dcdcdc">awaiter</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">IsCompleted)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">0</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __task1Awaiter </font><span style="color: "><font color="#b4b4b4">=</font></span></font><font face="Consolas"><font color="#dcdcdc"> awaiter;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The following call will eventually cause boxing of the state machine.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __builder</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">AwaitUnsafeOnCompleted(</font><span style="color: "><font color="#569cd6">ref</font></span><font color="#dcdcdc"> awaiter, </font><span style="color: "><font color="#569cd6">ref</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">this</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">else</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; awaiter </font><span style="color: "><font color="#b4b4b4">=</font></span></font><font face="Consolas"><font color="#dcdcdc"> __task1Awaiter;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __task1Awaiter </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">default</font></span><font color="#dcdcdc">(</font><span style="color: "><font color="#4ec9b0">TaskAwaiter</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">1</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// GetResult returns void, but it'll throw if the awaited task failed.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// This exception is catched later and changes the resulting task.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; awaiter</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">GetResult();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">_stocks</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryGetValue(companyId, </font><span style="color: "><font color="#569cd6">out</font></span></font><font face="Consolas"><font color="#dcdcdc"> result);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">catch</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#4ec9b0">Exception</font></span></font><font face="Consolas"><font color="#dcdcdc"> exception)<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Final state: failure</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">2</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __builder</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">SetException(exception);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Final state: success</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __state </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">-</font></span><span style="color: "><font color="#b5cea8">2</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __builder</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">SetResult(result);<br>&nbsp;&nbsp;&nbsp; }<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">void</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b8d7a3">IAsyncStateMachine</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">SetStateMachine(</font><span style="color: "><font color="#b8d7a3">IAsyncStateMachine</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc"> stateMachine)<br>&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __builder</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">SetStateMachine(stateMachine);<br>&nbsp;&nbsp;&nbsp; }<br>}</font></font></font></pre>
<p>Even though the state machine is similar to a hand-crafted one it has a few very important differences:
<p><strong>1. "Hot path" optimization</strong>
<p>Unlike our naive approach, the generated state machine is aware that an awaited task could be completed already.<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><font color="#dcdcdc"><font style="font-size: 11pt">awaiter </font></font><font style="font-size: 11pt"><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc"> __this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">InitializeLocalStoreIfNeededAsync()</font><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc">GetAwaiter();<br> </font><br></font><font face="Consolas"><font color="#57a64a"><span style="color: ">// Hot path optimization: if the task is completed,</span><br><span style="color: ">// the state machine automatically moves to the next step</span></font><br><span style="color: "><font color="#569cd6">if</font></span><font color="#dcdcdc"> (</font><span style="color: "><font color="#b4b4b4">!</font></span><font color="#dcdcdc">awaiter</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">IsCompleted)<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Irrelevant stuff</font></span><br></font><font face="Consolas"><font color="#dcdcdc"> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The following call will eventually cause boxing of the state machine.</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; __builder</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">AwaitUnsafeOnCompleted(</font><span style="color: "><font color="#569cd6">ref</font></span><font color="#dcdcdc"> awaiter, </font><span style="color: "><font color="#569cd6">ref</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">this</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">);<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">;<br>}</font></font></font></pre>
<p>If the awaited task is already finished (successfully or not) the state machine moves forward to the next step:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><font color="#57a64a"><span style="color: "><font style="font-size: 11pt">// GetResult returns void, but it'll throw if the awaited task failed.</font></span><font style="font-size: 11pt"><br><span style="color: ">// This exception is catched later and changes the resulting task.</span></font></font><font style="font-size: 11pt"><br><font color="#dcdcdc">awaiter</font><span style="color: "><font color="#b4b4b4">.</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">GetResult();<br>__this</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">_stocks</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">TryGetValue(companyId, </font><span style="color: "><font color="#569cd6">out</font></span><font color="#dcdcdc"> result);</font></font></font><br></pre>
<p><strong>It means that if all awaited tasks are already completed the entire state machine will leave on the stack</strong>. An async method even today could have an extremely small memory overhead if all awaited tasks are completed already or will be completed synchroonously. The only remaining allocation will be for the task itself!
<p><strong>2. Error handling</strong> As you may see there is no special logic that covers faulted or canceled state of the awaited tasks. The state machine calls <code>awaiter.GetResult()</code> that will throw <code>TaskCancelledException</code> if the task was canceled or another exception if the task was failed. This is a quite elegant solution that works fine here because <code>GetResult()</code> is a bit different in terms of error handling than <code>task.Wait()</code> or <code>task.Result</code>.
<p>Both <code>task.Wait()</code> and <code>task.Result</code> throw <code>AggregateException</code> even when there is just one exception that caused a task to fail. The reason for this is pretty simple: a task can represent not only IO-bound operation that usually has just one failure but the result of a parallel computation as well. In the latter case, the operation can have more than one error and <code>AggregateException</code> is designed to carry all these errors in one place.
<p>But <code>async/await</code> pattern is designed specifically for asynchronous operations that usually have at most one error. So the language authors decided that it will make more sense if <code>awaiter.GetResult()</code> will "unwrap" an <code>AggregateException</code> and throw just the first failure. This design decision is not perfect and in one of the next posts, we'll see when this abstraction can leak.
<p>The async state machine represents just one piece of the puzzle. To understand the whole picture we need to know how a state machine instance interacts with <code>TaskAwaiter&lt;T&gt;</code> and <code>AsyncTaskMethodBuilder&lt;T&gt;</code>.
<h5>How different pieces are glued together?</h5>
<p>(<a href="https://github.com/SergeyTeplyakov/DissectingTheCode/blob/master/posts/Images/Async_sequence_state_machine.png">https://github.com/SergeyTeplyakov/DissectingTheCode/blob/master/posts/Images/Async_sequence_state_machine.png</a> "Async workflow")
<p>The chart looks overly complicated but each piece is well-design and plays an important role. The most interesting collaboration is happening when an awaited task is not finished (marked with the brown rectangle in the diagram):
<ul>
<li>The state machine calls <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,535"><code>__builder.AwaitUnsafeOnCompleted(ref awaiter, ref this);</code></a> to register itself as the task's continuation. 
<li>The builder makes sure that when the task is finished a <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/IAsyncStateMachine.cs,25"><code>IAsyncStateMachine.MoveNext</code></a> method gets called: 
<ul>
<li>The builder <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,916">captures</a> the current <code>ExecutionContext</code> and creates a <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,049bf1fe30f53fe3"><code>MoveNextRunner</code></a> instance to associate it with the current state machine instance. Then it creates an <code>Action</code> instance from <a href="http://referencesource.microsoft.com/#mscorlib/system/runtime/compilerservices/AsyncMethodBuilder.cs,8539e615974ae806"><code>MoveNextRunner.Run</code></a> that will move the state machine forward under the captured execution context. 
<li>The builder calls <code>TaskAwaiter.UnsafeOnCompleted(action)</code>that schedules a given action as a continuation of an awaited task.</li></ul></li></ul>
<p>When the awaited task completes, the given callback is called and the state machine runs the next code block of the asynchronous method.
<h5>Execution Context</h5>
<p>One may wonder: what is the execution context and why we need all that complexity?
<p>In the synchronous world, each thread keeps ambient information in a thread-local storage. It can be security-related information, culture-specific data, or something else. When 3 methods are called sequentially in one thread this information flows naturally between all of them. But this is no longer true for asynchronous methods. Each "section" of an asynchronous method can be executed in different threads that makes thread-local information unusable.
<p>Execution context keeps the information for one logical flow of control even when it spans multiple threads.
<p>Methods like <code>Task.Run</code> or <code>ThreadPool.QueueUserWorkItem</code> do this automatically. <code>Task.Run</code> method captures <code>ExecutionContext</code> from the invoking thread and stores it with the <code>Task</code> instance. When the <code>TaskScheduler</code> associated with the task runs a given delegate, it runs it via <code>ExecutionContext.Run</code> using the stored context.
<p>We can use <a href="http://referencesource.microsoft.com/#mscorlib/system/threading/asynclocal.cs,ef9ce034697240ba"><code>AsyncLocal&lt;T&gt;</code></a> to demonstrate this concept in action:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 11pt">static</font></font></span><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc"> ExecutionContextInAction()<br>{<br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> li </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">AsyncLocal</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc">&gt;();<br>&nbsp;&nbsp;&nbsp; li</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Value </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">42</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br> <br>&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">return</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Run(() </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// Task.Run restores the execution context</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"In Task.Run: "</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">+</font></span><font color="#dcdcdc"> li</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Value);<br>&nbsp;&nbsp;&nbsp; })</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">ContinueWith(_ </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><br></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The continuation restores the execution context as well</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"In Task.ContinueWith: "</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">+</font></span><font color="#dcdcdc"> li</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Value);<br>&nbsp;&nbsp;&nbsp; });<br>}</font></font></font></pre>
<p>In these cases, the execution context flows through <code>Task.Run</code> and then to <code>Task.ContinueWith</code> method. So if you run this method you'll see:<pre><code><p>In Task.Run: 42
In Task.ContinueWith: 42
</p></code></pre>
<p>But not all methods in the BCL will automatically capture and restore the execution context. Two exceptions are <code>TaskAwaiter&lt;T&gt;.UnsafeOnComplete</code>and <code>AsyncMethodBuilder&lt;T&gt;.AwaitUnsafeOnComplete</code>. It looks weird that the language authors decided to add "unsafe" methods to flow the execution context manually using <code>AsyncMethodBuilder&lt;T&gt;</code> and <code>MoveNextRunner</code>instead of relying on a built-in facilities like <a href="http://referencesource.microsoft.com/#mscorlib/system/threading/Tasks/TaskContinuation.cs,543"><code>AwaitTaskContinuation</code></a>. I suspect there were some performance reasons or anther restrictions on the existing implementation.
<p>Here is an example that demonstrates the difference:<pre style="font-family: ; background: #1e1e1e; color: "><font face="Consolas"><span style="color: "><font color="#569cd6"><font style="font-size: 11pt">static</font></font></span><font style="font-size: 11pt"><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">async</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span></font></font><font style="font-size: 11pt"><font face="Consolas"><font color="#dcdcdc"> ExecutionContextInAsyncMethod()<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> li </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#569cd6">new</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">AsyncLocal</font></span><font color="#dcdcdc">&lt;</font><span style="color: "><font color="#569cd6">int</font></span></font><font face="Consolas"><font color="#dcdcdc">&gt;();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; li</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Value </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b5cea8">42</font></span></font><font face="Consolas"><font color="#dcdcdc">;<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">await</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Delay(</font><span style="color: "><font color="#b5cea8">42</font></span></font><font face="Consolas"><font color="#dcdcdc">);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The context is implicitely captured. li.Value is 42</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"After first await: "</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">+</font></span><font color="#dcdcdc"> li</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Value);<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">var</font></span><font color="#dcdcdc"> tsk2 </font><span style="color: "><font color="#b4b4b4">=</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#4ec9b0">Task</font></span><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Yield();<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; tsk2</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">GetAwaiter()</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">UnsafeOnCompleted(() </font><span style="color: "><font color="#b4b4b4">=&gt;</font></span><br></font><font face="Consolas"><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The context is not captured: li.Value is 0</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"Inside UnsafeOnCompleted: "</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">+</font></span><font color="#dcdcdc"> li</font><span style="color: "><font color="#b4b4b4">.</font></span></font><font face="Consolas"><font color="#dcdcdc">Value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; });<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#569cd6">await</font></span></font></font><font face="Consolas"><font style="font-size: 11pt"><font color="#dcdcdc"> tsk2;<br> <br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#57a64a">// The context is captured: li.Value is 42</font></span><br><font color="#dcdcdc">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </font><span style="color: "><font color="#4ec9b0">Console</font></span><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">WriteLine(</font><span style="color: "><font color="#d69d85">"After second await: "</font></span><font color="#dcdcdc">&nbsp;</font><span style="color: "><font color="#b4b4b4">+</font></span><font color="#dcdcdc"> li</font><span style="color: "><font color="#b4b4b4">.</font></span><font color="#dcdcdc">Value);<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</font></font></font></pre>
<p>The output is:<pre><code><p>After first await: 42
Inside UnsafeOnCompleted: 0
After second await: 42
</p></code></pre>
<h4>Conclusion</h4>
<ul>
<li>Async methods are very different from the synchronous methods. 
<li>The compiler generates a state machine per each method and moves all the logic of the original method there. 
<li>The generated code is highly optimized for a synchronous scenario: if all awaited tasks are completed, then the overhead of an async method is minimal. 
<li>If an awaited task is not completed, the logic relies on a lot of helper types to get the job done.</li></ul>
<h4>References</h4>
<p>If you want to learn more about execution context, I highly recommend the following two blog pots:
<ul>
<li><a href="https://blogs.msdn.microsoft.com/pfxteam/2012/06/15/executioncontext-vs-synchronizationcontext/">ExecutionContext vs SynchronizationContext</a> by Stephen Toub and 
<li><a href="https://blog.stephencleary.com/2013/04/implicit-async-context-asynclocal.html">Implicit Async Context ("AsyncLocal")</a> by Stephen Cleary</li></ul>
<p><strong>Next</strong>: we'll explore an extensibility model of asynchronous methods in C#.</p>